<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Paper Toss - Daur Ulang Sampah</title>
    
    <!-- A-Frame Core (Versi stabil) -->
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    
    <!-- MindAR Image Tracking -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <!-- A-Frame Physics System (Kompatibel dengan 1.0.4) -->
    <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@3.3.0/dist/aframe-physics-system.min.js"></script>
    
    <!-- CANNON.js Physics Engine -->
    <script src="https://cdn.jsdelivr.net/npm/cannon@0.6.2/build/cannon.min.js"></script>
    
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        #ui-overlay {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
        }
        
        #score-display {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        #instructions {
            font-size: 12px;
            color: #aaa;
        }
        
        #throw-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            z-index: 1000;
        }
        
        #drag-area {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background: linear-gradient(to top, rgba(76, 175, 80, 0.3), transparent);
            border-top: 2px dashed rgba(76, 175, 80, 0.5);
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        
        #drag-area.active {
            background: linear-gradient(to top, rgba(255, 152, 0, 0.4), transparent);
            border-top: 2px dashed rgba(255, 152, 0, 0.8);
        }
        
        #drag-instruction {
            font-size: 18px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- UI Overlay -->
    <div id="ui-overlay">
        <div id="score-display">Skor: 0</div>
        <div id="instructions">
            üì± Arahkan kamera ke stiker target<br>
            üëÜ Tap layar untuk melempar kertas<br>
            üéØ Masukkan ke tong yang sesuai!
        </div>
    </div>
    
    <div id="throw-indicator" class="hidden">
        TAP untuk LEMPAR! üéØ
    </div>
    
    <div id="drag-area" class="hidden">
        <div id="drag-instruction">üëÜ DRAG KE ATAS untuk LEMPAR! üéØ</div>
    </div>

    <!-- AR Scene -->
    <a-scene 
        mindar-image="imageTargetSrc: ./assets/targets.mind; autoStart: true; uiLoading: yes; uiScanning: yes; uiError: yes;"
        color-space="sRGB"
        renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        physics="gravity: -9.8; debug: false;">
        
        <!-- Camera -->
        <a-camera 
            position="0 0 0" 
            look-controls="enabled: false"
            cursor="fuse: false; rayOrigin: mouse;"
            raycaster="objects: .clickable">
        </a-camera>
        
        <!-- Lights -->
        <a-entity light="type: ambient; color: #BBB; intensity: 0.8;"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.6" position="-0.5 1 1"></a-entity>
        
        <!-- Image Target Anchor -->
        <a-entity id="marker" mindar-image-target="targetIndex: 0">
            
            <!-- Ground Platform (Invisible) -->
            <a-box 
                position="0 -0.3 0" 
                width="2" 
                height="0.1" 
                depth="1.5"
                color="#333"
                opacity="0.3"
                static-body>
            </a-box>
            
            <!-- Tong Sampah Merah (Anorganik) -->
            <a-entity position="-0.6 0 0">
                <a-cylinder 
                    id="tong-merah"
                    color="#e74c3c"
                    radius="0.15"
                    height="0.4"
                    position="0 -0.05 0">
                </a-cylinder>
                <a-text 
                    value="ANORGANIK"
                    color="white"
                    align="center"
                    width="0.8"
                    position="0 0.3 0"
                    rotation="0 0 0">
                </a-text>
                <!-- Goal Zone - Di Mulut Tong -->
                <a-cylinder
                    class="goal-zone"
                    data-bin-type="anorganik"
                    position="0 0.15 0"
                    radius="0.14"
                    height="0.15"
                    opacity="0"
                    static-body>
                </a-cylinder>
            </a-entity>
            
            <!-- Tong Sampah Hijau (Organik) -->
            <a-entity position="0 0 0">
                <a-cylinder 
                    id="tong-hijau"
                    color="#27ae60"
                    radius="0.15"
                    height="0.4"
                    position="0 -0.05 0">
                </a-cylinder>
                <a-text 
                    value="ORGANIK"
                    color="white"
                    align="center"
                    width="0.8"
                    position="0 0.3 0"
                    rotation="0 0 0">
                </a-text>
                <!-- Goal Zone - Di Mulut Tong -->
                <a-cylinder
                    class="goal-zone"
                    data-bin-type="organik"
                    position="0 0.15 0"
                    radius="0.14"
                    height="0.15"
                    opacity="0"
                    static-body>
                </a-cylinder>
            </a-entity>
            
            <!-- Tong Sampah Biru (Kertas) -->
            <a-entity position="0.6 0 0">
                <a-cylinder 
                    id="tong-biru"
                    color="#3498db"
                    radius="0.15"
                    height="0.4"
                    position="0 -0.05 0">
                </a-cylinder>
                <a-text 
                    value="KERTAS"
                    color="white"
                    align="center"
                    width="0.8"
                    position="0 0.3 0"
                    rotation="0 0 0">
                </a-text>
                <!-- Goal Zone - Di Mulut Tong -->
                <a-cylinder
                    class="goal-zone"
                    data-bin-type="kertas"
                    position="0 0.15 0"
                    radius="0.14"
                    height="0.15"
                    opacity="0"
                    static-body>
                </a-cylinder>
            </a-entity>
            
        </a-entity>
    </a-scene>

    <script>
        // Game State
        let score = 0;
        let isMarkerVisible = false;
        let sceneReady = false;
        let currentBall = null;
        let isDragging = false;
        let dragStartY = 0;
        let dragStartTime = 0;
        
        // DOM Elements
        const scoreDisplay = document.getElementById('score-display');
        const throwIndicator = document.getElementById('throw-indicator');
        const dragArea = document.getElementById('drag-area');
        
        // Wait for scene to be ready
        const scene = document.querySelector('a-scene');
        scene.addEventListener('loaded', () => {
            console.log('‚úÖ Scene loaded!');
            sceneReady = true;
            setupMarkerListeners();
            setupDragControls();
        });
        
        // Update Score Display
        function updateScore(points) {
            score += points;
            scoreDisplay.textContent = `Skor: ${score}`;
            
            // Visual feedback
            scoreDisplay.style.color = points > 0 ? '#4CAF50' : '#f44336';
            setTimeout(() => {
                scoreDisplay.style.color = 'white';
            }, 500);
        }
        
        // Setup marker detection
        function setupMarkerListeners() {
            const marker = document.querySelector('#marker');
            if (!marker) {
                console.error('‚ùå Marker not found!');
                return;
            }
            
            // Show/Hide controls when marker is detected
            marker.addEventListener('targetFound', event => {
                console.log('‚úÖ Marker detected!');
                isMarkerVisible = true;
                dragArea.classList.remove('hidden');
                throwIndicator.classList.remove('hidden');
                throwIndicator.textContent = 'üéØ Siap melempar!';
                
                // Create initial ball
                if (!currentBall) {
                    createPaperBall();
                }
            });
            
            marker.addEventListener('targetLost', event => {
                console.log('‚ö†Ô∏è Marker lost!');
                isMarkerVisible = false;
                dragArea.classList.add('hidden');
                throwIndicator.classList.add('hidden');
                
                // DON'T remove ball - it's attached to camera, not marker
            });
        }
        
        // Create Paper Ball (positioned at camera/screen, not marker!)
        function createPaperBall() {
            console.log('üéæ Creating paper ball at CAMERA...');
            
            const scene = document.querySelector('a-scene');
            const camera = document.querySelector('a-camera');
            
            if (!scene || !camera) {
                console.error('‚ùå Scene or camera not found!');
                return null;
            }
            
            const ball = document.createElement('a-sphere');
            
            // Ball properties - BIGGER and BRIGHTER untuk terlihat jelas
            ball.setAttribute('radius', '0.12'); // Lebih besar lagi
            ball.setAttribute('color', '#FFD700'); // Gold/kuning terang
            ball.setAttribute('shadow', 'cast: true');
            ball.setAttribute('metalness', '0.5');
            ball.setAttribute('roughness', '0.5');
            ball.setAttribute('segments-height', '16');
            ball.setAttribute('segments-width', '16');
            
            // Add glow effect
            ball.setAttribute('material', 'color: #FFD700; emissive: #FFA500; emissiveIntensity: 0.5');
            
            // PENTING: Posisi di DEPAN KAMERA - lebih dekat dan lebih bawah
            // x: 0 (tengah horizontal)
            // y: -0.15 (sedikit di bawah center)
            // z: -0.3 (sangat dekat ke kamera agar terlihat)
            ball.setAttribute('position', '0 -0.15 -0.3');
            
            // NO physics initially
            ball.setAttribute('id', 'active-ball');
            ball.classList.add('draggable-ball');
            
            // Add to CAMERA
            camera.appendChild(ball);
            console.log('‚úÖ Ball spawned at CAMERA position (0, -0.15, -0.3)');
            console.log('üé® Ball color: GOLD with glow effect');
            console.log('üìè Ball radius: 0.12 (large and visible)');
            
            currentBall = ball;
            return ball;
        }
        
        // Throw ball with physics
        function throwBall(velocity) {
            if (!currentBall || !currentBall.parentNode) {
                console.log('‚ö†Ô∏è No ball to throw');
                return;
            }
            
            console.log('üöÄ Throwing ball with velocity:', velocity.toFixed(2));
            
            // Get ball's current WORLD position before moving
            const ballWorldPos = new THREE.Vector3();
            currentBall.object3D.getWorldPosition(ballWorldPos);
            
            // Get camera rotation to calculate throw direction
            const camera = document.querySelector('a-camera');
            const cameraRot = camera.object3D.rotation;
            
            console.log('üìç Ball world position:', ballWorldPos.x.toFixed(2), ballWorldPos.y.toFixed(2), ballWorldPos.z.toFixed(2));
            
            // Remove from camera safely
            const parent = currentBall.parentNode;
            if (parent) {
                parent.removeChild(currentBall);
            }
            
            // Add to scene
            const scene = document.querySelector('a-scene');
            scene.appendChild(currentBall);
            
            // Set world position
            currentBall.object3D.position.copy(ballWorldPos);
            
            // Wait a bit for object to be in scene, then add physics
            setTimeout(() => {
                if (!currentBall || !currentBall.parentNode) {
                    console.error('‚ùå Ball disappeared!');
                    return;
                }
                
                // Add physics
                currentBall.setAttribute('dynamic-body', {
                    shape: 'sphere',
                    mass: 0.15,
                    linearDamping: 0.05,
                    angularDamping: 0.05
                });
                
                // Wait for physics body to load
                const checkPhysics = setInterval(() => {
                    if (currentBall && currentBall.body) {
                        clearInterval(checkPhysics);
                        
                        // Calculate throw direction
                        const powerMultiplier = 0.005;
                        const minForce = 1.5;
                        const upwardForce = Math.max(minForce, velocity * powerMultiplier);
                        
                        // Forward direction based on camera
                        const forwardVector = new THREE.Vector3(0, 0, -1);
                        forwardVector.applyQuaternion(camera.object3D.quaternion);
                        
                        const throwPower = 3.0;
                        const forceX = forwardVector.x * throwPower;
                        const forceY = upwardForce + 1.5; // More upward
                        const forceZ = forwardVector.z * throwPower;
                        
                        const impulse = new CANNON.Vec3(forceX, forceY, forceZ);
                        const worldPoint = new CANNON.Vec3(0, 0, 0);
                        
                        currentBall.body.applyImpulse(impulse, worldPoint);
                        console.log('üöÄ Force applied! X:', forceX.toFixed(2), 'Y:', forceY.toFixed(2), 'Z:', forceZ.toFixed(2));
                        
                        // Add spin
                        currentBall.body.angularVelocity.set(
                            Math.random() * 6 - 3,
                            Math.random() * 6 - 3,
                            Math.random() * 6 - 3
                        );
                    }
                }, 50);
                
                // Timeout after 1 second
                setTimeout(() => {
                    clearInterval(checkPhysics);
                    if (!currentBall || !currentBall.body) {
                        console.error('‚ùå Physics body failed to load!');
                    }
                }, 1000);
                
            }, 100);
            
            // Collision detection
            currentBall.addEventListener('collide', function(e) {
                const collidedEl = e.detail.body.el;
                
                if (collidedEl && collidedEl.classList.contains('goal-zone')) {
                    const binType = collidedEl.getAttribute('data-bin-type');
                    console.log('üéØ GOAL! Scored in:', binType);
                    
                    updateScore(10);
                    throwIndicator.textContent = 'üéâ MASUK! +10 Poin!';
                    throwIndicator.style.background = 'rgba(76, 175, 80, 0.9)';
                    
                    currentBall.setAttribute('color', '#4CAF50');
                    
                    setTimeout(() => {
                        if (currentBall && currentBall.parentNode) {
                            currentBall.parentNode.removeChild(currentBall);
                        }
                        currentBall = null;
                        throwIndicator.textContent = 'üéØ Siap melempar!';
                        
                        // Create new ball if marker still visible
                        if (isMarkerVisible) {
                            setTimeout(() => createPaperBall(), 500);
                        }
                    }, 1000);
                } else {
                    console.log('üí• Ball collided with:', collidedEl ? collidedEl.id : 'unknown');
                }
            });
            
            // Auto-remove and create new ball after 5 seconds
            setTimeout(() => {
                if (currentBall && currentBall.parentNode) {
                    console.log('üóëÔ∏è Removing old ball');
                    currentBall.parentNode.removeChild(currentBall);
                    currentBall = null;
                    
                    // Create new ball if marker still visible
                    if (isMarkerVisible) {
                        createPaperBall();
                    }
                }
            }, 5000);
        }
        
        // Setup Drag Controls (Paper Toss style)
        function setupDragControls() {
            let touchStartY = 0;
            let touchStartTime = 0;
            
            // Mouse events (desktop)
            document.addEventListener('mousedown', (e) => {
                if (!isMarkerVisible || !currentBall) return;
                
                isDragging = true;
                dragStartY = e.clientY;
                dragStartTime = Date.now();
                dragArea.classList.add('active');
                
                console.log('üñ±Ô∏è Drag started at Y:', dragStartY);
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging || !currentBall) return;
                
                const deltaY = dragStartY - e.clientY; // Positive = dragging up
                
                // Visual feedback
                if (deltaY > 50) {
                    throwIndicator.textContent = `‚¨ÜÔ∏è KUAT! (${Math.round(deltaY)}px)`;
                } else if (deltaY > 20) {
                    throwIndicator.textContent = `‚ÜóÔ∏è Sedang (${Math.round(deltaY)}px)`;
                } else {
                    throwIndicator.textContent = 'üëÜ Drag ke atas!';
                }
            });
            
            document.addEventListener('mouseup', (e) => {
                if (!isDragging) return;
                
                const deltaY = dragStartY - e.clientY;
                const deltaTime = Date.now() - dragStartTime;
                const velocity = Math.abs((deltaY / deltaTime) * 1000); // pixels per second, absolute value
                
                console.log('üñ±Ô∏è Drag released! ŒîY:', deltaY, 'Time:', deltaTime, 'ms, Velocity:', velocity.toFixed(2), 'px/s');
                
                isDragging = false;
                dragArea.classList.remove('active');
                
                // Check if we have a ball to throw
                if (!currentBall) {
                    console.log('‚ö†Ô∏è No ball available');
                    return;
                }
                
                // Only throw if dragged upward enough (at least 30px)
                if (deltaY > 30) {
                    throwBall(velocity);
                    throwIndicator.textContent = 'üöÄ MELEMPAR...';
                } else {
                    throwIndicator.textContent = '‚ö†Ô∏è Drag lebih tinggi! (min 30px)';
                    console.log('‚ö†Ô∏è Drag too weak:', deltaY, 'px');
                    setTimeout(() => {
                        throwIndicator.textContent = 'üéØ Siap melempar!';
                    }, 1500);
                }
            });
            
            // Touch events (mobile)
            document.addEventListener('touchstart', (e) => {
                if (!isMarkerVisible || !currentBall) return;
                
                isDragging = true;
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();
                dragArea.classList.add('active');
                
                console.log('üì± Touch drag started at Y:', touchStartY);
            }, { passive: false });
            
            document.addEventListener('touchmove', (e) => {
                if (!isDragging || !currentBall) return;
                e.preventDefault();
                
                const deltaY = touchStartY - e.touches[0].clientY;
                
                if (deltaY > 50) {
                    throwIndicator.textContent = `‚¨ÜÔ∏è KUAT! (${Math.round(deltaY)}px)`;
                } else if (deltaY > 20) {
                    throwIndicator.textContent = `‚ÜóÔ∏è Sedang (${Math.round(deltaY)}px)`;
                } else {
                    throwIndicator.textContent = 'üëÜ Drag ke atas!';
                }
            }, { passive: false });
            
            document.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                
                const touchEndY = e.changedTouches[0].clientY;
                const deltaY = touchStartY - touchEndY;
                const deltaTime = Date.now() - touchStartTime;
                const velocity = Math.abs((deltaY / deltaTime) * 1000);
                
                console.log('üì± Touch released! ŒîY:', deltaY, 'Time:', deltaTime, 'ms, Velocity:', velocity.toFixed(2), 'px/s');
                
                isDragging = false;
                dragArea.classList.remove('active');
                
                // Check if we have a ball to throw
                if (!currentBall) {
                    console.log('‚ö†Ô∏è No ball available');
                    return;
                }
                
                if (deltaY > 30) {
                    throwBall(velocity);
                    throwIndicator.textContent = 'üöÄ MELEMPAR...';
                } else {
                    throwIndicator.textContent = '‚ö†Ô∏è Drag lebih tinggi! (min 30px)';
                    console.log('‚ö†Ô∏è Touch drag too weak:', deltaY, 'px');
                    setTimeout(() => {
                        throwIndicator.textContent = 'üéØ Siap melempar!';
                    }, 1500);
                }
            }, { passive: false });
        }
        
        // Console instructions
        console.log('%cüéØ AR Paper Toss Game Loaded!', 'color: #4CAF50; font-size: 20px; font-weight: bold;');
        console.log('%cControls:', 'color: #2196F3; font-size: 14px;');
        console.log('1. Point camera at marker');
        console.log('2. DRAG ball upward to throw (like Paper Toss!)');
        console.log('3. Drag faster = stronger throw');
        console.log('%cüìù Drag & Release mechanic active!', 'color: #FF9800');
    </script>
</body>
</html>
</html>
